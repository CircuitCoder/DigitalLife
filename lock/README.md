---
documentclass:
  - ctexart
---

# Week 3 点亮数字人生

## 源代码
- **lock.vhdl**: 主程序
- **tb.vhdl**: 测试程序，生成输入序列：

- 先输入默认密码，成功
- 修改密码，成功
- 重复两次使用默认密码，失败
- 第三次使用接近设置的新密码，但是最后一位错误。
- 锁住，这时输入修改后的正确密码，没有效果
- 输入错误的 Admin 密码，回到锁死状态。
- 输入内置正确的 Admin 密码，正确，解锁
- 输入修改后的正确密码，成功

源码附在报告附录，波形文件附在报告侧。

## 项目结构
只有一个 entity，lock，代表锁。

## 状态说明
一共有两个状态机，第一个是锁目前进行的工作，一个是锁失败次数计数。

目前进行的工作如下：
- **IDLE**: 初始状态，以及失败之后的状态。显示失败灯。
- **ADMIN\_i**: 正在验证 Admin 密码的第 i 步。 i = 1,2,3,4
- **VERIFY\_i**: 正在验证用户密码的第 i 步。 i = 1,2,3,4
- **SET\_i**: 正在设置用户密码的第 i 步。 i = 1,2,3,4
- **SUCCESS**: 上一次操作整体成功，显示成功灯。包括设置、验证以及验证管理员成功后都会进入这个状态。

只有在 SUCCESS 模式下可以转移到 SET\_0，保证至少知道密码才能设置密码。

reset 的时候根据 mode 输入，进入不同的状态：
- mode = "00" and state = SUCCESS: 进入 SET\_0
- mode = "01" and lock != TRY\_3: 进入 VERIFY\_0。关于 lock 的定义见下方说明。
- mode = "10": 进入 ADMIN\_0

锁失败计数：
- **INITIAL**: 默认，用户还没有尝试过。
- **TRY\_i**: 用户经过了 i 次尝试。i = 1,2,3

每次进入 VERIFY\_0 的时候，这个状态增加，保证就算在验证走到一半的时候，reset 依旧算一次失败。

当状态为 TRY\_3 的时候，用户在 reset 时无法进入 VERIFY\_0，实现锁。

当状态为 TRY\_3 的时候，而且工作状态不是 VERIFY\_i 时，说明目前处于第三次尝试失败后，或者尝试使用管理员密码恢复时，这时候亮起失败灯。

当设置密码完成、管理员密码验证成功、验证成功后，会被重置会 INITIAL。

## 合成
VHDL 文件在 linux 环境下编写

合成、模拟程序是 GHDL 0.37-dev gcc:

```bash
# 合成
ghdl -a *.vhdl

# 以 tb 作为顶级 entity 进行模拟，1us 后自动停止，波形输出为 led.vcd
ghdl -r tb --stop-time=1000ns --vcd=led.vcd

# 使用 gtkwave 显示波形
gtkwave led.vcd
```
